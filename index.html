<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>UV Proxy Demo</title>

    <script>console.log("üîç Attempting to load Ultraviolet scripts‚Ä¶");</script>

    <!-- Load UV runtime + config (client-side encoder) -->
    <script
      src="https://cdn.jsdelivr.net/npm/@titaniumnetwork-dev/ultraviolet/dist/uv.bundle.js"
      onload="console.log('‚úÖ uv.bundle.js loaded')"
      onerror="console.error('‚ùå Failed to load uv.bundle.js')">
    </script>
    <script
      src="https://cdn.jsdelivr.net/npm/@titaniumnetwork-dev/ultraviolet/dist/uv.config.js"
      onload="console.log('‚úÖ uv.config.js loaded')"
      onerror="console.error('‚ùå Failed to load uv.config.js')">
    </script>

    <script>
      window.addEventListener("DOMContentLoaded", () => {
        console.log("üì¶ DOM ready ‚Äî checking __uv$config...");
        if (typeof __uv$config !== "undefined") {
          console.log("‚úÖ __uv$config detected:", __uv$config);
        } else {
          console.error("‚ùå __uv$config missing! Ultraviolet config failed.");
        }
      });
    </script>
  </head>
  <body>
    <div id="proxy-content">Loading‚Ä¶</div>

    <script>
      // Wait until UV config is defined
      window.addEventListener("load", () => {
        if (typeof __uv$config === "undefined") {
          console.error("Ultraviolet config failed to load!");
          document.getElementById("proxy-content").innerText =
            "Error: Ultraviolet config not found.";
          return;
        }

        // Your deployed UV server base
        const UV_SERVER = "https://ultraviolet-app-ebon-nu.vercel.app";
        const TARGET_ORIGIN = "https://coldnova.xyz"; // site you want to proxy

        const contentDiv = document.getElementById("proxy-content");
        let currentPath = "/";

        // Encode a full URL to route through UV server
        function uvEncode(url) {
          try {
            const encoded = UV_SERVER + __uv$config.prefix + __uv$config.encodeUrl(url);
            console.log("üîó Encoding URL:", url, "‚Üí", encoded);
            return encoded;
          } catch (err) {
            console.error("‚ùå uvEncode failed for", url, err);
            return url;
          }
        }

        async function fetchAndRender(path) {
          currentPath = path;
          const proxiedUrl = uvEncode(TARGET_ORIGIN + path);
          console.log("üåê Fetching proxied URL:", proxiedUrl);

          try {
            const resp = await fetch(proxiedUrl, { credentials: "omit" });
            console.log("üì• Response status:", resp.status);
            if (!resp.ok) throw new Error("Failed to fetch via UV server");
            let html = await resp.text();
            console.log("üìÑ Fetched HTML length:", html.length);

            const { bodyHTML, headElements } = rewriteDocument(html, TARGET_ORIGIN);

            contentDiv.innerHTML = bodyHTML;
            updateHead(headElements);
            interceptLinks();
          } catch (e) {
            console.error("‚ùå fetchAndRender error:", e);
            contentDiv.innerHTML = `<div style="color:red;padding:2em;">Failed to load: ${e.message}</div>`;
          }
        }

        function rewriteDocument(html, baseUrl) {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");

          const nodes = doc.querySelectorAll("[href], [src], iframe, embed, object");
          console.log("üîß Rewriting", nodes.length, "nodes");

          nodes.forEach((el) => {
            const tag = el.tagName.toLowerCase();

            if (el.hasAttribute("href")) {
              const newHref = new URL(el.getAttribute("href"), baseUrl).href;
              el.setAttribute("href", uvEncode(newHref));
            }
            if (el.hasAttribute("src")) {
              const newSrc = new URL(el.getAttribute("src"), baseUrl).href;
              el.setAttribute("src", uvEncode(newSrc));
            }

            if (tag === "embed" && el.getAttribute("src")) {
              const originalSrc = new URL(el.getAttribute("src"), baseUrl).href;
              const div = document.createElement("div");
              div.className = "embed-container";
              div.dataset.src = uvEncode(originalSrc);
              div.textContent = `Embed proxied: ${originalSrc}`;
              el.replaceWith(div);
            }
          });

          return {
            bodyHTML: doc.body.innerHTML,
            headElements: [...doc.head.children],
          };
        }

        function updateHead(newHeadElements) {
          const head = document.head;
          head.querySelectorAll("[data-proxy-head]").forEach((el) => el.remove());

          newHeadElements.forEach((el) => {
            const clone = el.cloneNode(true);
            clone.setAttribute("data-proxy-head", "");
            if (clone.href) clone.href = uvEncode(clone.href);
            if (clone.src) clone.src = uvEncode(clone.src);
            head.appendChild(clone);
          });
          console.log("üß© Updated head with", newHeadElements.length, "elements");
        }

        function interceptLinks() {
          contentDiv.querySelectorAll("a[href]").forEach((a) => {
            a.addEventListener("click", (e) => {
              e.preventDefault();
              let href = a.getAttribute("href");
              if (!href) return;
              console.log("üñ±Ô∏è Intercepted link click:", href);
              fetchAndRender(new URL(href, TARGET_ORIGIN).pathname);
            });
          });
        }

        // Initial load
        fetchAndRender("/");
      });
    </script>
  </body>
</html>

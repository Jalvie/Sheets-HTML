<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ColdNova Fullscreen Proxy</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: sans-serif;
    }
    #proxy-container {
      width: 100%;
      height: 100%;
      overflow: auto;
      box-sizing: border-box;
    }
    #loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 1.5rem;
      color: #333;
    }
  </style>
</head>
<body>
  <div id="loading">Loading ColdNova...</div>
  <div id="proxy-container"></div>

<script>
  const container = document.getElementById('proxy-container');
  const loading = document.getElementById('loading');
  const targetUrl = 'https://coldnova.xyz/';

  function rewriteUrls(doc, baseUrl) {
    console.log("üîÑ Starting rewriteUrls()");
    console.log("üåê Base URL:", baseUrl);

    const elements = doc.querySelectorAll('[href], [src]');
    console.log("üîç Found elements with href/src:", elements.length);

    const tagNames = Array.from(elements).map(el => el.tagName.toLowerCase());
    console.log("üìå Matched tags:", tagNames);

    if (elements.length <= 1 && !tagNames.includes("iframe") && !tagNames.includes("a") && !tagNames.includes("img")) {
        console.warn("‚ö†Ô∏è Only found scripts or minimal elements ‚Äî maybe DOM isn't fully loaded.");
    }

    let iframeCounter = 0;

    elements.forEach((el, index) => {
        console.log(`\n======================`);
        console.log(`üîπ Processing element #${index + 1}:`, el);
        console.log("üìå Tag name:", el.tagName.toLowerCase());

        try {
            // Handle iframe/embed separately
            if (el.tagName.toLowerCase() === 'iframe' || el.tagName.toLowerCase() === 'embed') {
                console.log("üñº Found iframe/embed:", el);

                // Assign a unique ID to the iframe if it doesn't have one
                iframeCounter++;
                const iframeId = `iframe-${iframeCounter}`;
                el.id = iframeId;
                console.log(`üè∑ Assigned iframe ID: #${iframeId}`);

                // Get original size
                const originalWidth = el.getAttribute("width") || el.style.width || el.offsetWidth || "600";
                const originalHeight = el.getAttribute("height") || el.style.height || el.offsetHeight || "400";
                console.log(`üìè Preserving iframe size: ${originalWidth}x${originalHeight}`);

                const iframeSrc = el.getAttribute('src');
                console.log("üîó Original iframe src:", iframeSrc);

                if (iframeSrc) {
                    try {
                        const absUrl = new URL(iframeSrc, baseUrl).href;
                        console.log("‚úÖ Resolved iframe absolute URL:", absUrl);

                        // Remove original src to prevent auto-loading
                        el.removeAttribute('src');
                        el.dataset.proxySrc = absUrl;

                        // Keep iframe dimensions intact
                        el.style.width = typeof originalWidth === "number" ? originalWidth + "px" : originalWidth;
                        el.style.height = typeof originalHeight === "number" ? originalHeight + "px" : originalHeight;

                        console.log(`‚è≥ Calling loadIframe(#${iframeId})‚Ä¶`);
                        loadIframe(el, absUrl, originalWidth, originalHeight);
                    } catch (err) {
                        console.error("‚ùå Failed to resolve iframe URL:", iframeSrc, err);
                    }
                } else {
                    console.warn("‚ö†Ô∏è Iframe has no src attribute:", el);
                }
            } else {
                // Handle href
                if (el.hasAttribute('href')) {
                    const originalHref = el.getAttribute('href');
                    console.log("üîó Original href:", originalHref);
                    try {
                        el.href = new URL(originalHref, baseUrl).href;
                        console.log("‚úÖ Resolved absolute href:", el.href);
                    } catch (err) {
                        console.error("‚ùå Failed to resolve href:", originalHref, err);
                    }
                }

                // Handle src
                if (el.hasAttribute('src')) {
                    const originalSrc = el.getAttribute('src');
                    console.log("üñº Original src:", originalSrc);
                    try {
                        el.src = new URL(originalSrc, baseUrl).href;
                        console.log("‚úÖ Resolved absolute src:", el.src);
                    } catch (err) {
                        console.error("‚ùå Failed to resolve src:", originalSrc, err);
                    }
                }
            }
        } catch (err) {
            console.error("üî• Unexpected error processing element:", el, err);
        }
    });

    // Intercept <a> link clicks
    const links = doc.querySelectorAll('a');
    console.log("\nüîó Setting up link interception for", links.length, "links");

    links.forEach((a, i) => {
        console.log(`üõ† Setting click handler for link #${i + 1}:`, a.href);
        a.addEventListener('click', e => {
            console.log(`üñ± Click intercepted on: ${a.href}`);
            e.preventDefault();
            try {
                loadPage(a.href);
            } catch (err) {
                console.error("‚ùå Error calling loadPage for:", a.href, err);
            }
        });
    });

    console.log("‚úÖ Finished rewriteUrls()");
}


  // Remove ads
  function removeAds(doc) {
    doc.querySelectorAll('script[src*="googlesyndication"], script[src*="adsbygoogle"]').forEach(el => el.remove());
    doc.querySelectorAll('ins.adsbygoogle, .ad-container, .ads-container, [id*="ad"], [class*="ad"]').forEach(el => el.remove());
  }

  async function loadPage(url) {
    try {
      loading.style.display = 'block';
      container.innerHTML = '';
      const response = await fetch('https://corsproxy.io/?' + encodeURIComponent(url));
      const htmlText = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlText, 'text/html');

      removeAds(doc);
      rewriteUrls(doc, url);

      // Inject CSS
      doc.querySelectorAll('link[rel="stylesheet"]').forEach(link => {
        const newLink = document.createElement('link');
        newLink.rel = 'stylesheet';
        newLink.href = link.href;
        document.head.appendChild(newLink);
      });

      // Inject inline styles
      doc.querySelectorAll('style').forEach(style => {
        const newStyle = document.createElement('style');
        newStyle.textContent = style.textContent;
        document.head.appendChild(newStyle);
      });

      // Append body
      Array.from(doc.body.children).forEach(child => container.appendChild(child));

    } catch (err) {
      container.innerHTML = `<p style="color:red;">Failed to load page: ${err.message}</p>`;
      console.error(err);
    } finally {
      loading.style.display = 'none';
    }
  }

  // Load iframe content like the main page
  async function loadIframe(iframeEl, url) {
    try {
      const response = await fetch('https://corsproxy.io/?' + encodeURIComponent(url));
      const htmlText = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(htmlText, 'text/html');

      removeAds(doc);
      rewriteUrls(doc, url);

      // Create wrapper div instead of real iframe
      const wrapper = document.createElement('div');
      wrapper.style.border = '1px solid #ccc';
      wrapper.style.margin = '10px 0';
      wrapper.style.padding = '5px';
      wrapper.innerHTML = doc.body.innerHTML;

      iframeEl.replaceWith(wrapper);
    } catch (err) {
      const errorMsg = document.createElement('div');
      errorMsg.style.color = 'red';
      errorMsg.textContent = `Failed to load iframe: ${err.message}`;
      iframeEl.replaceWith(errorMsg);
    }
  }

  window.addEventListener('DOMContentLoaded', () => {
    loadPage(targetUrl);
  });
</script>
</body>
</html>
